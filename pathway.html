<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pathway - Smart Vocabulary Builder</title>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6b8cbc;
            --accent-color: #ff6b6b;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--dark-color);
            background-color: #f0f2f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .student-info-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--light-color);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .student-selector input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
            width: 250px;
        }

        .student-selector button {
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .student-selector button:hover {
            background-color: var(--secondary-color);
        }

        .student-progress {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .student-progress span {
            font-weight: 500;
        }

        .student-progress #studentDisplayName {
            color: var(--primary-color);
            font-size: 18px;
            font-weight: bold;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
        }

        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 12px 24px;
            background-color: #e9ecef;
            border: none;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
            margin: 0 2px;
        }

        .tab-button:hover {
            background-color: #d1d5db;
        }

        .tab-button.active {
            background-color: var(--primary-color);
            color: white;
        }

        .tab-content {
            display: none;
            background-color: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .section-title {
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        @media (min-width: 1200px) {
            .grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .card {
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .card h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: #212529;
        }

        .btn-warning:hover {
            background-color: #e0a800;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-small {
            padding: 3px 8px;
            font-size: 11px;
        }

        .btn-block {
            display: block;
            width: 100%;
        }

        .word-list {
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            padding: 15px;
            background-color: white;
            min-height: 200px;
        }

        .word-list.no-scroll {
            max-height: none;
            overflow-y: visible;
        }

        .word-item {
            padding: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
        }
        
        .word-info {
            flex: 2;
            min-width: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .word-info span {
            font-size: 14px;
            color: #6c757d;
        }
        
        .word-actions {
            display: flex;
            gap: 5px;
            flex-shrink: 0;
            flex: 1;
            justify-content: flex-end;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 0;
            border-radius: var(--border-radius);
            width: 400px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            padding: 20px;
            background-color: var(--primary-color);
            color: white;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #ccc;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-body .form-group {
            margin-bottom: 15px;
        }

        .modal-body .form-group:last-child {
            margin-bottom: 0;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-body label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .modal-body input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
        }

        .modal-body .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .button-row {
            display: flex;
            justify-content: flex-start;
            margin-bottom: 10px;
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .header-row h3 {
            margin: 0;
        }

        .button-row .btn {
            margin-left: 10px;
        }

        .word-info {
            flex-grow: 1;
        }

        .word-actions {
            display: flex;
            gap: 10px;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .badge-learning {
            background-color: var(--warning-color);
            color: #212529;
        }

        .badge-mastered {
            background-color: var(--success-color);
            color: white;
        }

        .badge-special {
            background-color: var(--accent-color);
            color: white;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
        }

        .notification {
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            min-width: 300px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .notification.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .notification.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .student-buttons {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .student-button {
            padding: 8px 16px;
            background-color: #e9ecef;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .student-button:hover {
            background-color: #d1d5db;
        }
        
        .student-button.active {
            background-color: var(--primary-color);
            color: white;
        }

        .notification.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .reward-item {
            padding: 15px;
            border-left: 4px solid var(--success-color);
            background-color: #f8f9fa;
            margin-bottom: 15px;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
        }

        .reward-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .reward-title {
            font-weight: bold;
            color: var(--primary-color);
        }

        .reward-date {
            color: #6c757d;
            font-size: 14px;
        }

        .reward-notes {
            color: #495057;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .student-selector {
                flex-direction: column;
            }
            
            .student-selector input {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Pathway - Smart Vocabulary Builder</h1>
            <div class="student-info-bar">
                <div class="student-selector">
                    <input type="text" id="studentName" placeholder="Enter student name">
                    <button id="setStudent">Set Student</button>
                </div>
                <div id="studentProgress" class="student-progress">
                    <span id="studentDisplayName"></span>
                    <span id="currentPosition">Current Position: Step 1, Level 1</span>
                    <button id="editPosition" class="btn btn-primary">Edit Position</button>
                    <button id="deleteStudent" class="btn btn-danger" style="display: none;">Delete Student</button>
                </div>
            </div>
            <div id="studentButtons" class="student-buttons"></div>
            <div id="notification" class="notification"></div>
        </header>

        <div class="tabs" style="display: none;">
            <button class="tab-button active" data-tab="learning">Learning Words</button>
            <button class="tab-button" data-tab="special">Special Words</button>
            <button class="tab-button" data-tab="rewards">Achievements</button>
        </div>

        <!-- Learning Words Tab -->
        <div id="learning-tab" class="tab-content active">
            
            <div class="grid">
                <div class="card">
                    <h3>Add Regular Words</h3>
                    <div class="form-group">
                        <label for="stepLevel">Step & Level</label>
                        <select id="stepLevel" class="step-level-select">
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="form-group">
                        <button id="loadWordsBtn" class="btn btn-primary">Load Words</button>
                    </div>
                    <div id="wordListContainer" style="display: none;">
                        <h4>Available Words:</h4>
                        <div id="availableWords" class="word-list"></div>
                        <button id="addSelectedWords" class="btn btn-success btn-block">Add Selected to Learning List</button>
                        <button id="addAllWords" class="btn btn-primary btn-block" style="margin-top: 10px;">Add All to Learning List</button>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Special Words Management</h3>
                    <div class="form-group">
                        <label for="newSpecialWord">Add New Special Word(s):</label>
                        <textarea id="newSpecialWord" placeholder="Enter special word(s) - separate multiple words with commas, spaces, or new lines. You can add words that already exist in the main 2800-word list if needed." rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="specialWordNotes">Notes (Optional):</label>
                        <textarea id="specialWordNotes" placeholder="Additional information about these words"></textarea>
                    </div>
                    <button id="addSpecialWord" class="btn btn-primary">Add Special Word(s)</button>
                    <p><small>If a word already exists in the main 2800-word list, you'll be notified of its step and level and given the option to add it as a special word anyway.</small></p>
                </div>
                
                <div class="card">
                    <div class="header-row">
                        <h3>Current Learning List</h3>
                        <div>
                            <button id="copyListBtn" class="btn btn-primary">Copy List</button>
                            <button id="generateStoryBtn" class="btn btn-success">Generate Story</button>
                            <button id="generateQuestionsBtn" class="btn btn-info">Generate Questions</button>
                            <button id="clearListBtn" class="btn btn-danger">Clear List</button>
                        </div>
                    </div>
                    <div class="search-box">
                        <input type="text" id="learningSearch" placeholder="Search learning words...">
                    </div>
                    <div id="learningWords" class="word-list">
                        <p>Select a student to view their learning words.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Special Words Tab -->
        <div id="special-tab" class="tab-content">
            
            <div class="grid">
                <div class="card">
                    <h3>Add New Special Word(s)</h3>
                    <div class="form-group">
                        <label for="newSpecialWord">Word(s)</label>
                        <textarea id="newSpecialWord" placeholder="Enter special word(s) - separate multiple words with commas, spaces, or new lines. You can add words that already exist in the main 2800-word list if needed." rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="specialWordNotes">Notes (Optional)</label>
                        <textarea id="specialWordNotes" placeholder="Additional information about these words"></textarea>
                    </div>
                    <button id="addSpecialWord" class="btn btn-primary">Add Special Word(s)</button>
                    <p><small>If a word already exists in the main 2800-word list, you'll be notified of its step and level and given the option to add it as a special word anyway.</small></p>
                </div>
                
                <div class="card">
                    <h3>Special Words List</h3>
                    <div class="search-box">
                        <input type="text" id="specialSearch" placeholder="Search special words...">
                    </div>
                    <div id="specialWords" class="word-list">
                        <p>No special words added yet.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rewards Tab -->
        <div id="rewards-tab" class="tab-content">
            
            <div class="card">
                <h3>Rewards & Recognition</h3>
                <div class="search-box">
                    <input type="text" id="rewardSearch" placeholder="Search rewards...">
                </div>
                <div id="rewardsList">
                    <p>No rewards earned yet.</p>
                </div>
            </div>
        </div>
    </div>

    </div>
    
    <!-- Position Modal -->
    <div id="positionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Update Student Position</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="editStep">Step (1-28):</label>
                    <input type="number" id="editStep" min="1" max="28" value="1">
                </div>
                <div class="form-group">
                    <label for="editLevel">Level (1-5):</label>
                    <input type="number" id="editLevel" min="1" max="5" value="1">
                </div>
                <div class="form-group">
                    <button id="savePosition" class="btn btn-primary">Save Position</button>
                    <button id="cancelPosition" class="btn btn-secondary">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Debug: Log when script starts
        console.log('Script loaded');
        
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const stepLevelSelect = document.getElementById('stepLevel');
        const loadWordsBtn = document.getElementById('loadWordsBtn');
        const wordListContainer = document.getElementById('wordListContainer');
        const availableWordsContainer = document.getElementById('availableWords');
        const addSelectedWordsBtn = document.getElementById('addSelectedWords');
        const addAllWordsBtn = document.getElementById('addAllWords');
        const learningWordsContainer = document.getElementById('learningWords');
        const learningSearchInput = document.getElementById('learningSearch');
        const newSpecialWordInput = document.getElementById('newSpecialWord');
        const specialWordNotesInput = document.getElementById('specialWordNotes');
        const addSpecialWordBtn = document.getElementById('addSpecialWord');
        const specialWordsContainer = document.getElementById('specialWords');
        const specialSearchInput = document.getElementById('specialSearch');
        const rewardsListContainer = document.getElementById('rewardsList');
        const rewardSearchInput = document.getElementById('rewardSearch');
        const copyListBtn = document.getElementById('copyListBtn');
        const generateStoryBtn = document.getElementById('generateStoryBtn');
        const generateQuestionsBtn = document.getElementById('generateQuestionsBtn');
        const clearListBtn = document.getElementById('clearListBtn');
        const studentButtonsContainer = document.getElementById('studentButtons');
        const deleteStudentBtn = document.getElementById('deleteStudent');
        
        // Modal elements
        const positionModal = document.getElementById('positionModal');
        const editStepInput = document.getElementById('editStep');
        const editLevelInput = document.getElementById('editLevel');
        const savePositionBtn = document.getElementById('savePosition');
        const cancelPositionBtn = document.getElementById('cancelPosition');
        const closeSpan = document.querySelector('.close');
        
        // Debug: Log modal elements
        console.log('Modal elements loaded:');
        console.log('positionModal:', positionModal);
        console.log('editStepInput:', editStepInput);
        console.log('editLevelInput:', editLevelInput);
        
        // Student info elements
        const studentNameInput = document.getElementById('studentName');
        const setStudentBtn = document.getElementById('setStudent');
        const studentDisplayName = document.getElementById('studentDisplayName');
        const currentPosition = document.getElementById('currentPosition');
        const editPositionBtn = document.getElementById('editPosition');
        const notification = document.getElementById('notification');
        
        // Debug: Log student elements
        console.log('Student elements loaded:');
        console.log('editPositionBtn:', editPositionBtn);

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Populate step/level select
            populateStepLevelSelect();
            
            // Load student buttons
            loadStudentButtons();
            
            // Hide delete student button initially
            deleteStudentBtn.style.display = 'none';
            
            // Debug: Check if modal elements exist
            console.log('Modal elements:');
            console.log('positionModal:', positionModal);
            console.log('editPositionBtn:', editPositionBtn);
            console.log('savePositionBtn:', savePositionBtn);
            console.log('cancelPositionBtn:', cancelPositionBtn);
            console.log('closeSpan:', closeSpan);
            
            // Set up event listeners
            console.log('Setting up event listeners');
            setStudentBtn.addEventListener('click', setStudent);
            loadWordsBtn.addEventListener('click', loadWords);
            addSelectedWordsBtn.addEventListener('click', addSelectedWords);
            addAllWordsBtn.addEventListener('click', addAllWords);
            addSpecialWordBtn.addEventListener('click', addSpecialWord);
            copyListBtn.addEventListener('click', copyLearningListToClipboard);
            generateStoryBtn.addEventListener('click', generateStory);
            generateQuestionsBtn.addEventListener('click', generateQuestions);
            clearListBtn.addEventListener('click', clearLearningList);
            deleteStudentBtn.addEventListener('click', deleteStudent);
            
            console.log('Adding editPositionBtn event listener');
            editPositionBtn.addEventListener('click', function() {
                console.log('Edit position button clicked');
                openPositionModal();
            });
            savePositionBtn.addEventListener('click', saveStudentPosition);
            cancelPositionBtn.addEventListener('click', closePositionModal);
            closeSpan.addEventListener('click', closePositionModal);
            
            // Close modal when clicking outside of it
            window.addEventListener('click', function(event) {
                // Debug: Log click event
                console.log('Click event:', event.target);
                
                if (event.target === positionModal) {
                    closePositionModal();
                }
                
                // Hide word lists when clicking outside of them
                if (wordListContainer && wordListContainer.style.display === 'block' && 
                    !wordListContainer.contains(event.target) && 
                    event.target !== loadWordsBtn) {
                    console.log('Hiding word list container');
                    wordListContainer.style.display = 'none';
                }
            });
            
            // Prevent word lists from closing when clicking inside them
            wordListContainer.addEventListener('click', function(event) {
                event.stopPropagation();
            });
            
            // Set up search functionality
            learningSearchInput.addEventListener('input', filterLearningWords);
            specialSearchInput.addEventListener('input', filterSpecialWords);
            rewardSearchInput.addEventListener('input', filterRewards);
            
            // Check if student is already set in localStorage
            const savedStudent = localStorage.getItem('pathwayStudent');
            if (savedStudent) {
                studentNameInput.value = savedStudent;
                setStudent();
            }
        });

        // Populate step/level select dropdown
        function populateStepLevelSelect() {
            stepLevelSelect.innerHTML = '';
            for (let step = 1; step <= 28; step++) {
                for (let level = 1; level <= 5; level++) {
                    const option = document.createElement('option');
                    option.value = `${step}-${level}`;
                    option.textContent = `Step ${step} - Level ${level}`;
                    stepLevelSelect.appendChild(option);
                }
            }
        }

        // Set current student
        function setStudent() {
            const studentName = studentNameInput.value.trim();
            if (!studentName) {
                showNotification('Please enter a student name', 'error');
                return;
            }
            
            console.log('Setting student to:', studentName);
            currentStudent = studentName;
            localStorage.setItem('pathwayStudent', studentName);
            
            // Update UI with student name
            studentDisplayName.textContent = studentName;
            
            // Show delete button when a student is selected
            deleteStudentBtn.style.display = 'inline-block';
            
            // Load student progress (will initialize to defaults if new student)
            loadStudentProgress();
            
            showNotification(`Student "${studentName}" selected. Use "Load Words" to add words to their learning list.`, 'success');
            
            // Load data for the student
            console.log('Loading data for student:', studentName);
            loadStudentData();
            
            // Update student buttons
            updateStudentButtons();
        }

        // Delete current student
        function deleteStudent() {
            if (!currentStudent) {
                showNotification('No student selected', 'error');
                return;
            }
            
            // Show confirmation dialog
            if (!confirm(`Are you sure you want to delete student "${currentStudent}" and all associated data? This action cannot be undone.`)) {
                return;
            }
            
            // Send delete request to backend
            fetch(`/api/student/${currentStudent}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showNotification(data.error, 'error');
                    return;
                }
                
                showNotification(data.message, 'success');
                
                // Clear student data from UI
                studentNameInput.value = '';
                studentDisplayName.textContent = '';
                currentPosition.textContent = 'Current Position: Step 1, Level 1';
                learningWordsContainer.innerHTML = '<p>Select a student to view their learning words.</p>';
                specialWordsContainer.innerHTML = '<p>No special words added yet.</p>';
                rewardsListContainer.innerHTML = '<p>No rewards earned yet.</p>';
                
                // Hide delete button
                deleteStudentBtn.style.display = 'none';
                
                // Clear current student
                currentStudent = null;
                localStorage.removeItem('pathwayStudent');
                
                // Reload student buttons
                loadStudentButtons();
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error deleting student', 'error');
            });
        }

        // Copy learning list to clipboard
        function copyLearningListToClipboard() {
            if (!currentStudent) {
                showNotification('Please set a student first', 'error');
                return;
            }
            
            if (learningWords.length === 0) {
                showNotification('No learning words to copy', 'error');
                return;
            }
            
            // Create a list of words, one per line
            const wordsList = learningWords
                .filter(word => word.status === 'learning') // Only copy learning words, not mastered ones
                .map(word => word.word)
                .join('\n');
            
            // Copy to clipboard
            navigator.clipboard.writeText(wordsList)
                .then(() => {
                    showNotification('Learning list copied to clipboard!', 'success');
                })
                .catch(err => {
                    console.error('Failed to copy: ', err);
                    showNotification('Failed to copy to clipboard', 'error');
                });
        }
        function loadStudentProgress() {
            if (!currentStudent) return;
            
            console.log('Loading student progress for:', currentStudent);
            fetch(`/api/student/${currentStudent}/progress`)
            .then(response => {
                if (response.status === 404) {
                    console.log('Student not found, initializing with defaults');
                    initializeNewStudent();
                    return null;
                }
                return response.json();
            })
            .then(data => {
                if (data) {
                    console.log('Student progress data:', data);
                    currentStep = data.step;
                    currentLevel = data.level;
                    updatePositionDisplay();
                }
            })
            .catch(error => {
                console.error('Error loading student progress:', error);
                // Initialize with defaults on error
                initializeNewStudent();
            });
        }

        // Update the position display in the UI
        function updatePositionDisplay() {
            if (currentStudent) {
                currentPosition.textContent = `Current Position: Step ${currentStep}, Level ${currentLevel}`;
            } else {
                currentPosition.textContent = 'Current Position: Step 1, Level 1';
            }
        }

        // Open the position modal
        function openPositionModal() {
            console.log('openPositionModal called');
            if (!currentStudent) {
                showNotification('Please set a student first', 'error');
                return;
            }
            
            console.log('Setting values:', currentStep, currentLevel);
            editStepInput.value = currentStep;
            editLevelInput.value = currentLevel;
            positionModal.style.display = 'block';
            console.log('Modal should be visible now');
        }

        // Close the position modal
        function closePositionModal() {
            console.log('closePositionModal called');
            positionModal.style.display = 'none';
        }

        // Save student position
        function saveStudentPosition() {
            const step = parseInt(editStepInput.value);
            const level = parseInt(editLevelInput.value);
            
            if (!step || !level || step < 1 || step > 28 || level < 1 || level > 5) {
                showNotification('Please enter valid step (1-28) and level (1-5)', 'error');
                return;
            }
            
            fetch(`/api/student/${currentStudent}/progress`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ step, level })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showNotification(data.error, 'error');
                    return;
                }
                
                currentStep = step;
                currentLevel = level;
                updatePositionDisplay();
                closePositionModal();
                showNotification(data.message, 'success');
                
                // Update the step/level selector to match the new position
                stepLevelSelect.value = `${step}-${level}`;
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error updating student position', 'error');
            });
        }

        // Load student data
        function loadStudentData() {
            if (!currentStudent) return;
            
            console.log('Loading student data for:', currentStudent);
            // Load all data for the student
            loadLearningWords();
            loadStudentSpecialWords();
            loadRewards();
            updateStudentButtons();
        }

        // Load list of students and create buttons
        function loadStudentButtons() {
            fetch('/api/students')
            .then(response => response.json())
            .then(data => {
                renderStudentButtons(data.students);
            })
            .catch(error => {
                console.error('Error loading students:', error);
            });
        }

        // Render student buttons
        function renderStudentButtons(students) {
            if (students.length === 0) {
                studentButtonsContainer.innerHTML = '';
                return;
            }
            
            let html = '<h4>Quick Select Students:</h4>';
            students.forEach(student => {
                const isActive = student === currentStudent;
                html += `<button class="student-button ${isActive ? 'active' : ''}" onclick="selectStudent('${student}')">${student}</button>`;
            });
            
            studentButtonsContainer.innerHTML = html;
        }

        // Update student buttons to highlight the current student
        function updateStudentButtons() {
            const buttons = studentButtonsContainer.querySelectorAll('.student-button');
            buttons.forEach(button => {
                if (button.textContent === currentStudent) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
        }

        // Select a student from the buttons
        function selectStudent(studentName) {
            studentNameInput.value = studentName;
            setStudent();
        }

        // Load learning words for current student
        function loadLearningWords() {
            if (!currentStudent) return;
            
            // Fetch from the backend
            fetch(`/api/student/${currentStudent}/learning_words`)
            .then(response => response.json())
            .then(data => {
                console.log('Learning words data:', data);
                learningWords = data.words;
                renderLearningWords();
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error loading learning words', 'error');
            });
        }

        // Render learning words to the UI
        function renderLearningWords(words = learningWords) {
            if (!currentStudent) {
                learningWordsContainer.innerHTML = '<p>Select a student to view their learning words.</p>';
                return;
            }
            
            if (words.length === 0) {
                learningWordsContainer.innerHTML = `<p>No learning words found for ${currentStudent}. Add words using the "Load Words" or "Add Special Word" functions.</p>`;
                return;
            }
            
            let html = '';
            words.forEach(word => {
                // Check if it's a special word (indicated by a property or by step/level being null)
                const isSpecial = word.is_special || word.word_type === 'special' || (!word.step && !word.level);
                const displayWord = isSpecial ? `${word.word}*` : word.word;
                
                html += `
                    <div class="word-item">
                        <div class="word-info">
                            <strong>${displayWord}</strong>
                            <span>
                                ${isSpecial ? 
                                    '<small>Special Word</small>' : 
                                    `<small>- Step ${word.step}, Level ${word.level}</small>`}
                            </span>
                        </div>
                        <div class="word-actions">
                            <button class="btn btn-danger btn-small" onclick="removeWord(${word.id}, ${isSpecial})">Remove</button>
                        </div>
                    </div>
                `;
            });
            
            learningWordsContainer.innerHTML = html;
        }

        // Filter learning words based on search input
        function filterLearningWords() {
            const searchTerm = learningSearchInput.value.toLowerCase();
            const filteredWords = learningWords.filter(word => 
                word.word.toLowerCase().includes(searchTerm)
            );
            renderLearningWords(filteredWords);
        }

        // Load words for current position
        function loadWordsForCurrentPosition() {
            if (!currentStudent) return;
            
            // Fetch words for current step and level
            fetch(`/api/words/step/${currentStep}/level/${currentLevel}`)
            .then(response => response.json())
            .then(data => {
                availableWords = data.words.map(word => ({
                    id: word.id,
                    word: word.word,
                    is_special: false
                }));
                renderAvailableWords();
                wordListContainer.style.display = 'block';
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error loading words for current position', 'error');
            });
        }

        // Load available words for a step/level
        function loadWords() {
            console.log('loadWords called');
            console.log('Current student:', currentStudent);
            console.log('Current step:', currentStep);
            console.log('Current level:', currentLevel);
            
            // Check if student is set
            if (!currentStudent) {
                showNotification('Please set a student first', 'error');
                return;
            }
            
            // Use the student's current step and level, not the dropdown value
            const step = currentStep;
            const level = currentLevel;
            
            console.log('Loading words for step:', step, 'level:', level);
            
            // Update the dropdown to match the current position
            stepLevelSelect.value = `${step}-${level}`;
            
            // Fetch from the backend
            fetch(`/api/words/step/${step}/level/${level}`)
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Words data received:', data);
                availableWords = data.words.map(word => ({
                    id: word.id,
                    word: word.word,
                    is_special: false
                }));
                renderAvailableWords();
                wordListContainer.style.display = 'block';
                console.log('Word list container displayed');
                showNotification(`Loaded ${data.words.length} words for Step ${step}, Level ${level}`, 'success');
            })
            .catch(error => {
                console.error('Error loading words:', error);
                showNotification('Error loading words: ' + error.message, 'error');
            });
        }

        // Render available words to the UI
        function renderAvailableWords() {
            console.log('renderAvailableWords called with:', availableWords);
            let html = '';
            availableWords.forEach(word => {
                // Check if it's a special word
                const isSpecial = word.is_special || word.type === 'special';
                const displayWord = isSpecial ? `${word.word}*` : word.word;
                
                html += `
                    <div class="word-item">
                        <div class="word-info">
                            <strong>${displayWord}</strong>
                        </div>
                        <div class="word-actions">
                            <input type="checkbox" id="word-${word.id}" data-id="${word.id}" data-word="${word.word}" ${isSpecial ? 'data-special="true"' : ''}>
                        </div>
                    </div>
                `;
            });
            
            availableWordsContainer.innerHTML = html;
            // Remove scroll restrictions to fit all words
            availableWordsContainer.parentElement.classList.add('no-scroll');
            availableWordsContainer.parentElement.style.maxHeight = 'none';
        }

        // Add selected words to learning list
        function addSelectedWords() {
            const selectedCheckboxes = document.querySelectorAll('input[type="checkbox"]:checked');
            if (selectedCheckboxes.length === 0) {
                showNotification('Please select at least one word to add', 'error');
                return;
            }
            
            const regularWordIds = [];
            const specialWordIds = [];
            
            selectedCheckboxes.forEach(cb => {
                // Check if it's a special word (based on a data attribute or by ID range)
                if (cb.dataset.special === 'true') {
                    specialWordIds.push(parseInt(cb.dataset.id));
                } else {
                    regularWordIds.push(parseInt(cb.dataset.id));
                }
            });
            
            // Send to the backend
            fetch(`/api/student/${currentStudent}/learning_words`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    word_ids: regularWordIds,
                    special_word_ids: specialWordIds
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showNotification(data.error, 'error');
                    return;
                }
                
                showNotification(data.message, 'success');
                
                // Clear selection
                selectedCheckboxes.forEach(cb => cb.checked = false);
                
                // Reload learning words
                loadLearningWords();
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error adding words to learning list', 'error');
            });
        }

        // Add all words to learning list
        function addAllWords() {
            if (!currentStudent) {
                showNotification('Please set a student first', 'error');
                return;
            }
            
            if (availableWords.length === 0) {
                showNotification('No words available to add', 'error');
                return;
            }
            
            // Get all word IDs
            const regularWordIds = availableWords
                .filter(word => !word.is_special)
                .map(word => word.id);
                
            const specialWordIds = availableWords
                .filter(word => word.is_special)
                .map(word => word.id);
            
            console.log('Adding all words:', { regularWordIds, specialWordIds });
            
            // Send to the backend
            fetch(`/api/student/${currentStudent}/learning_words`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    word_ids: regularWordIds,
                    special_word_ids: specialWordIds
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showNotification(data.error, 'error');
                    return;
                }
                
                showNotification(`Added ${regularWordIds.length + specialWordIds.length} words to learning list`, 'success');
                
                // Reload learning words
                loadLearningWords();
                
                // Hide the word list
                wordListContainer.style.display = 'none';
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error adding words to learning list', 'error');
            });
        }

        // Add special word
        function addSelectedSpecialWords() {
            const selectedCheckboxes = document.querySelectorAll('#availableSpecialWords input[type="checkbox"]:checked');
            console.log('Selected checkboxes:', selectedCheckboxes);
            if (selectedCheckboxes.length === 0) {
                showNotification('Please select at least one special word to add', 'error');
                return;
            }
            
            const specialWordIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.id));
            console.log('Special word IDs to add:', specialWordIds);
            
            // Send to the backend
            fetch(`/api/student/${currentStudent}/learning_words`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    special_word_ids: specialWordIds
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showNotification(data.error, 'error');
                    return;
                }
                
                showNotification(data.message, 'success');
                
                // Clear selection
                selectedCheckboxes.forEach(cb => cb.checked = false);
                
                // Reload learning words
                loadLearningWords();
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error adding special words to learning list', 'error');
            });
        }
        
        // Removed addSelectedSpecialWords function - no longer needed

        // Mark word as mastered
        function markAsMastered(wordId, isSpecial = false) {
            // In a real implementation, this would update the backend
            if (isSpecial) {
                // Mark special word as mastered
                fetch(`/api/student/${currentStudent}/special_words/${wordId}/master`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    showNotification(data.message, 'success');
                    // Reload learning words
                    loadLearningWords();
                    // Reload special words
                    loadStudentSpecialWords();
                    // Reload rewards
                    loadRewards();
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('Error marking special word as mastered', 'error');
                });
            } else {
                // Mark regular word as mastered
                fetch(`/api/student/${currentStudent}/learning_words/${wordId}/master`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    showNotification(data.message, 'success');
                    // Reload learning words
                    loadLearningWords();
                    // Reload rewards
                    loadRewards();
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('Error marking word as mastered', 'error');
                });
            }
        }

        // Mark word as learning
        function markAsLearning(wordId, isSpecial = false) {
            // In a real implementation, this would update the backend
            if (isSpecial) {
                // Mark special word as learning
                fetch(`/api/student/${currentStudent}/special_words/${wordId}/learning`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    showNotification(data.message, 'success');
                    // Reload learning words
                    loadLearningWords();
                    // Reload special words
                    loadSpecialWords();
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('Error marking special word as learning', 'error');
                });
            } else {
                // Mark regular word as learning
                fetch(`/api/student/${currentStudent}/learning_words/${wordId}/learning`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    showNotification(data.message, 'success');
                    // Reload learning words
                    loadLearningWords();
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('Error marking word as learning', 'error');
                });
            }
        }

        // Remove word from learning list
        function removeWord(wordId, isSpecial = false) {
            // In a real implementation, this would update the backend
            if (isSpecial) {
                // Remove special word
                fetch(`/api/student/${currentStudent}/learning_special_words/${wordId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    showNotification(data.message, 'success');
                    // Reload learning words
                    loadLearningWords();
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('Error removing special word', 'error');
                });
            } else {
                // Remove regular word
                fetch(`/api/student/${currentStudent}/learning_words/${wordId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    showNotification(data.message, 'success');
                    // Reload learning words
                    loadLearningWords();
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('Error removing word', 'error');
                });
            }
        }

        // Add special word(s)
        function addSpecialWord() {
            const wordsInput = newSpecialWordInput.value.trim();
            const notes = specialWordNotesInput.value.trim();
            
            if (!wordsInput) {
                showNotification('Please enter at least one special word', 'error');
                return;
            }
            
            // Split input into words using commas, newlines, or multiple spaces as delimiters
            // Also trim whitespace from each word and filter out empty strings
            const words = wordsInput.split(/[\s,]+/).map(word => word.trim()).filter(word => word.length > 0);
            
            if (words.length === 0) {
                showNotification('Please enter at least one valid special word', 'error');
                return;
            }
            
            // Send to the backend using batch endpoint
            sendAddSpecialWordsRequest(words, notes, false);
        }
        
        // Function to send the request to add special words
        function sendAddSpecialWordsRequest(words, notes, forceAdd) {
            fetch(`/api/student/${currentStudent}/special_words/batch`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ words, notes, force_add: forceAdd })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Add special words response:', data);
                
                // Handle existing words that user might want to force add
                if (data.results && data.results.existing && data.results.existing.length > 0 && !forceAdd) {
                    // Show dialog to user asking if they want to force add existing words
                    const existingWords = data.results.existing;
                    const wordList = existingWords.map(w => 
                        `${w.word} (Step ${w.step}, Level ${w.level})`
                    ).join(', ');
                    
                    if (confirm(`The following words already exist in the main 2800-word list:
${wordList}

Do you want to add them as special words anyway?`)) {
                        // User wants to force add, send request again with force_add=true
                        sendAddSpecialWordsRequest(words, notes, true);
                        return;
                    }
                }
                
                // Clear form
                newSpecialWordInput.value = '';
                specialWordNotesInput.value = '';
                
                // Show appropriate notification
                let message = '';
                let type = 'info';
                
                if (data.results && data.results.added && data.results.added.length > 0) {
                    message += `Added ${data.results.added.length} special word(s). `;
                    type = 'success';
                }
                
                if (data.results && data.results.existing && data.results.existing.length > 0) {
                    const existingWords = data.results.existing.map(w => 
                        `${w.word} (Step ${w.step}, Level ${w.level})`
                    ).join(', ');
                    message += `${data.results.existing.length} word(s) already exist: ${existingWords}. `;
                }
                
                if (data.results && data.results.errors && data.results.errors.length > 0) {
                    const errorMessages = data.results.errors.map(err => 
                        `${err.word}: ${err.error}`
                    ).join(', ');
                    message += `Errors: ${errorMessages}. `;
                    if (type === 'success') type = 'info'; else type = 'error';
                }
                
                if (!message) {
                    message = data.message || 'Completed with no changes';
                }
                
                showNotification(message, type);
                
                // Reload special words and learning words
                loadStudentSpecialWords();
                loadLearningWords();
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error adding special words: ' + error.message, 'error');
            });
        }

        // Load special words for current student (for the special words tab)
        function loadStudentSpecialWords() {
            if (!currentStudent) return;
            
            // Fetch from the backend
            fetch(`/api/student/${currentStudent}/special_words`)
            .then(response => response.json())
            .then(data => {
                console.log('Student special words data:', data);
                specialWords = data.words;
                renderSpecialWords();
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error loading special words', 'error');
            });
        }

        // Render special words to the UI
        function renderSpecialWords(words = specialWords) {
            if (!currentStudent) {
                specialWordsContainer.innerHTML = '<p>Select a student to view their special words.</p>';
                return;
            }
            
            if (words.length === 0) {
                specialWordsContainer.innerHTML = '<p>No special words added yet.</p>';
                return;
            }
            
            let html = '';
            words.forEach(word => {
                const badgeClass = word.status === 'learning' ? 'badge-learning' : 'badge-mastered';
                const badgeText = word.status === 'learning' ? 'Learning' : 'Mastered';
                
                html += `
                    <div class="word-item">
                        <div class="word-info">
                            <strong>${word.word}</strong>
                            <div>
                                <small>${word.notes || 'No notes'}</small>
                            </div>
                            <div>
                                <small>Added: ${new Date(word.addedDate).toLocaleDateString()}</small>
                            </div>
                        </div>
                        <div class="word-actions">
                            <span class="badge ${badgeClass}">${badgeText}</span>
                            ${word.status === 'learning' ? 
                                `<button class="btn btn-success btn-small" onclick="markAsMastered(${word.id}, true)">Mark Mastered</button>` :
                                `<button class="btn btn-warning btn-small" onclick="markAsLearning(${word.id}, true)">Mark Learning</button>`
                            }
                            <button class="btn btn-danger btn-small" onclick="removeWord(${word.id}, true)">Remove</button>
                        </div>
                    </div>
                `;
            });
            
            specialWordsContainer.innerHTML = html;
        }

        // Filter special words based on search input
        function filterSpecialWords() {
            const searchTerm = specialSearchInput.value.toLowerCase();
            const filteredWords = specialWords.filter(word => 
                word.word.toLowerCase().includes(searchTerm) ||
                (word.notes && word.notes.toLowerCase().includes(searchTerm))
            );
            renderSpecialWords(filteredWords);
        }

        // Add reward for mastered word
        function addReward(wordId, isSpecial) {
            // In a real implementation, this would send data to the backend
            const word = isSpecial 
                ? specialWords.find(w => w.id === wordId)
                : learningWords.find(w => w.id === wordId);
                
            if (!word) return;
            
            const reward = {
                id: Date.now(),
                word: word.word,
                type: isSpecial ? 'special_word_mastered' : 'word_mastered',
                date: new Date().toISOString(),
                notes: `Mastered the ${isSpecial ? 'special ' : ''}word "${word.word}"`
            };
            
            rewards.unshift(reward); // Add to beginning of array
            renderRewards();
        }

        // Load rewards for current student
        function loadRewards() {
            if (!currentStudent) return;
            
            // Fetch from the backend
            fetch(`/api/student/${currentStudent}/rewards`)
            .then(response => response.json())
            .then(data => {
                rewards = data.rewards;
                renderRewards();
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error loading rewards', 'error');
            });
        }

        // Render rewards to the UI
        function renderRewards(rewardsList = rewards) {
            if (!currentStudent) {
                rewardsListContainer.innerHTML = '<p>Select a student to view their achievements.</p>';
                return;
            }
            
            if (rewardsList.length === 0) {
                rewardsListContainer.innerHTML = '<p>No rewards earned yet.</p>';
                return;
            }
            
            let html = '';
            rewardsList.forEach(reward => {
                html += `
                    <div class="reward-item">
                        <div class="reward-header">
                            <div class="reward-title">${reward.notes}</div>
                            <div class="reward-date">${new Date(reward.date).toLocaleDateString()}</div>
                        </div>
                        <div class="reward-type">
                            <span class="badge badge-${reward.type.includes('special') ? 'special' : 'mastered'}">
                                ${reward.type.replace('_', ' ').toUpperCase()}
                            </span>
                        </div>
                    </div>
                `;
            });
            
            rewardsListContainer.innerHTML = html;
        }

        // Filter rewards based on search input
        function filterRewards() {
            const searchTerm = rewardSearchInput.value.toLowerCase();
            const filteredRewards = rewards.filter(reward => 
                reward.word.toLowerCase().includes(searchTerm) ||
                reward.notes.toLowerCase().includes(searchTerm)
            );
            renderRewards(filteredRewards);
        }

        // Switch between tabs
        function switchTab(tabName) {
            // Update tab buttons
            tabButtons.forEach(button => {
                if (button.dataset.tab === tabName) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
            
            // Update tab content
            tabContents.forEach(content => {
                if (content.id === `${tabName}-tab`) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
        }

        // Show notification
        function showNotification(message, type) {
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            // Add animation effect
            notification.style.opacity = '0';
            notification.style.transform = 'translateY(-20px)';
            
            // Animate in
            setTimeout(() => {
                notification.style.transition = 'all 0.3s ease';
                notification.style.opacity = '1';
                notification.style.transform = 'translateY(0)';
            }, 10);
            
            // Hide after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(-20px)';
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 300);
            }, 3000);
        }

        // Clear the entire learning list
        function clearLearningList() {
            if (!currentStudent) {
                showNotification('Please set a student first', 'error');
                return;
            }
            
            if (learningWords.length === 0) {
                showNotification('Learning list is already empty', 'info');
                return;
            }
            
            if (!confirm('Are you sure you want to clear the entire learning list? This action cannot be undone.')) {
                return;
            }
            
            // Create arrays of word IDs to delete
            const regularWordIds = learningWords
                .filter(word => !word.is_special && !word.word_type)
                .map(word => word.id);
                
            const specialWordIds = learningWords
                .filter(word => word.is_special || word.word_type === 'special')
                .map(word => word.id);
            
            // Create an array of fetch promises for deleting words
            const deletePromises = [];
            
            // Delete regular words
            regularWordIds.forEach(wordId => {
                deletePromises.push(
                    fetch(`/api/student/${currentStudent}/learning_words/${wordId}`, {
                        method: 'DELETE'
                    })
                );
            });
            
            // Delete special words
            specialWordIds.forEach(wordId => {
                deletePromises.push(
                    fetch(`/api/student/${currentStudent}/learning_special_words/${wordId}`, {
                        method: 'DELETE'
                    })
                );
            });
            
            // Execute all delete requests
            Promise.all(deletePromises)
                .then(responses => {
                    // Check if all requests were successful
                    const allSuccessful = responses.every(response => response.ok);
                    if (allSuccessful) {
                        showNotification('Learning list cleared successfully', 'success');
                        // Reload learning words
                        loadLearningWords();
                    } else {
                        throw new Error('Some delete requests failed');
                    }
                })
                .catch(error => {
                    console.error('Error clearing learning list:', error);
                    showNotification('Error clearing learning list', 'error');
                });
        }

        // Generate a story using the learning words
        function generateStory() {
            if (!currentStudent) {
                showNotification('Please set a student first', 'error');
                return;
            }
            
            if (learningWords.length === 0) {
                showNotification('No learning words to generate a story with', 'error');
                return;
            }
            
            // Show loading notification
            showNotification('Generating story... This may take a moment.', 'info');
            
            // Disable the button while generating
            generateStoryBtn.disabled = true;
            generateStoryBtn.textContent = 'Generating...';
            
            // Send request to backend to generate story
            fetch(`/api/student/${currentStudent}/generate_story`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Copy story to clipboard
                navigator.clipboard.writeText(data.story)
                    .then(() => {
                        showNotification('Story generated and copied to clipboard!', 'success');
                    })
                    .catch(err => {
                        console.error('Failed to copy story: ', err);
                        showNotification('Story generated but failed to copy to clipboard. Please copy manually.', 'info');
                        // Show the story in an alert as a fallback
                        alert('Story generated:\n\n' + data.story);
                    });
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error generating story: ' + error.message, 'error');
            })
            .finally(() => {
                // Re-enable the button
                generateStoryBtn.disabled = false;
                generateStoryBtn.textContent = 'Generate Story';
            });
        }

        // Generate multiple choice questions using the learning words
        function generateQuestions() {
            if (!currentStudent) {
                showNotification('Please set a student first', 'error');
                return;
            }
            
            if (learningWords.length === 0) {
                showNotification('No learning words to generate questions with', 'error');
                return;
            }
            
            // Show loading notification
            showNotification('Generating questions... This may take a moment.', 'info');
            
            // Disable the button while generating
            generateQuestionsBtn.disabled = true;
            generateQuestionsBtn.textContent = 'Generating...';
            
            // Send request to backend to generate questions
            fetch(`/api/student/${currentStudent}/generate_questions`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Copy questions to clipboard
                navigator.clipboard.writeText(data.questions)
                    .then(() => {
                        showNotification('Questions generated and copied to clipboard!', 'success');
                    })
                    .catch(err => {
                        console.error('Failed to copy questions: ', err);
                        showNotification('Questions generated but failed to copy to clipboard. Please copy manually.', 'info');
                        // Show the questions in an alert as a fallback
                        alert('Questions generated:\n\n' + data.questions);
                    });
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error generating questions: ' + error.message, 'error');
            })
            .finally(() => {
                // Re-enable the button
                generateQuestionsBtn.disabled = false;
                generateQuestionsBtn.textContent = 'Generate Questions';
            });
        }

        // Make functions available globally for inline event handlers
        window.markAsMastered = markAsMastered;
        window.markAsLearning = markAsLearning;
        window.removeWord = removeWord;
    </script>
</body>
</html>